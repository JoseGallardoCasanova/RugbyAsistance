// üèâ RUGBY ATTENDANCE - ASISTENCIAS (P√öBLICO)
// Google Apps Script para gesti√≥n de Asistencias
// ‚úÖ ACTUALIZADO: B√∫squeda DIN√ÅMICA de posici√≥n de jugadores

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    Logger.log('üì• Action: ' + action);
    
    if (action === 'obtenerAsistencia') return obtenerAsistencia(data);
    if (action === 'inicializar') return inicializarSheet(data);
    if (action === 'actualizarCategorias') return actualizarCategoriasEnHojas(data);
    
    return guardarAsistencia(data);
    
  } catch (error) {
    Logger.log('‚ùå Error: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'Rugby Attendance Asistencias API v4.0',
    features: ['B√∫squeda din√°mica de jugadores', 'Sincronizaci√≥n categor√≠as']
  })).setMimeType(ContentService.MimeType.JSON);
}

// ==================== GUARDAR ASISTENCIA (B√öSQUEDA DIN√ÅMICA) ====================

function guardarAsistencia(data) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = data.sheetName;
    let sheet = ss.getSheetByName(sheetName);
    
    // Auto-create si no existe
    if (!sheet && data.autoCreate) {
      Logger.log('üöÄ Auto-creando sheet: ' + sheetName);
      const resultado = inicializarSheetAuto({
        sheetName: sheetName,
        mes: data.mes,
        a√±o: data.a√±o,
        jugadores: data.jugadores,
        categorias: data.categorias || []
      });
      
      if (!resultado.success) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: 'No se pudo crear el sheet: ' + resultado.error,
          autoCreated: false
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      sheet = ss.getSheetByName(sheetName);
    }
    
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: 'Sheet no encontrado: ' + sheetName
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // ‚úÖ NUEVO: Procesar updates con b√∫squeda din√°mica
    if (data.updates && data.updates.length > 0) {
      const updatesReales = procesarUpdatesConBusqueda(sheet, data.updates);
      
      Logger.log('üì¶ Updates a aplicar: ' + updatesReales.length);
      
      updatesReales.forEach(function(update) {
        const range = sheet.getRange(update.range);
        range.setValue(update.value);
        
        if (update.backgroundColor) range.setBackground(update.backgroundColor);
        if (update.fontColor) range.setFontColor(update.fontColor);
        range.setHorizontalAlignment('center');
      });
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      updatedCells: data.updates ? data.updates.length : 0,
      autoCreated: false
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('‚ùå Error al guardar: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ‚úÖ NUEVA FUNCI√ìN: Buscar jugadores din√°micamente
function procesarUpdatesConBusqueda(sheet, updates) {
  const allData = sheet.getDataRange().getValues();
  const updatesReales = [];
  
  // Agrupar updates por jugador
  updates.forEach(function(update) {
    const nombreJugador = update.nombreJugador;
    const dia = update.dia;
    const valor = update.value;
    const backgroundColor = update.backgroundColor;
    const fontColor = update.fontColor;
    
    Logger.log('üîç Buscando jugador: ' + nombreJugador + ' para d√≠a ' + dia);
    
    // Buscar el jugador en la hoja
    var filaJugador = -1;
    
    for (var i = 0; i < allData.length; i++) {
      const cellValue = allData[i][0]; // Columna A (Nombre)
      
      if (cellValue && cellValue.toString().trim() === nombreJugador.trim()) {
        filaJugador = i + 1; // +1 porque arrays empiezan en 0
        Logger.log('‚úÖ Jugador encontrado en fila: ' + filaJugador);
        break;
      }
    }
    
    if (filaJugador === -1) {
      Logger.log('‚ö†Ô∏è Jugador no encontrado: ' + nombreJugador);
      return; // Skip este update
    }
    
    // Calcular columna (d√≠a)
    const columna = getColumnaParaDia(dia);
    const range = columna + filaJugador;
    
    Logger.log('üìç Range calculado: ' + range + ' para jugador ' + nombreJugador);
    
    updatesReales.push({
      range: range,
      value: valor,
      backgroundColor: backgroundColor,
      fontColor: fontColor
    });
  });
  
  return updatesReales;
}

function getColumnaParaDia(dia) {
  const columnIndex = dia + 1; // D√≠a 1 = columna B (√≠ndice 2)
  let columnLetter = '';
  let temp = columnIndex;
  
  while (temp > 0) {
    temp--;
    columnLetter = String.fromCharCode(65 + (temp % 26)) + columnLetter;
    temp = Math.floor(temp / 26);
  }
  
  return columnLetter;
}

// ==================== ACTUALIZAR CATEGOR√çAS ====================

function actualizarCategoriasEnHojas(data) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const categorias = data.categorias || [];
    
    Logger.log('üîÑ Actualizando categor√≠as en todas las hojas...');
    Logger.log('üìã Categor√≠as recibidas: ' + categorias.length);
    
    const todasLasHojas = ss.getSheets();
    let hojasActualizadas = 0;
    let errores = [];
    
    todasLasHojas.forEach(function(sheet) {
      const nombreHoja = sheet.getName();
      
      if (nombreHoja === 'Configuraci√≥n' || nombreHoja === 'Datos') {
        Logger.log('‚è≠Ô∏è Saltando hoja: ' + nombreHoja);
        return;
      }
      
      try {
        Logger.log('üìù Actualizando hoja: ' + nombreHoja);
        
        const data = sheet.getDataRange().getValues();
        let actualizaciones = 0;
        
        for (var i = 0; i < data.length; i++) {
          const cellValue = data[i][0];
          
          if (cellValue && typeof cellValue === 'string') {
            const matchCategoria = cellValue.match(/CATEGOR√çA\s+(\d+)/i);
            
            if (matchCategoria) {
              const numero = parseInt(matchCategoria[1]);
              const categoriaNueva = buscarCategoriaPorNumero(numero, categorias);
              
              if (categoriaNueva && categoriaNueva.nombre !== cellValue) {
                sheet.getRange(i + 1, 1).setValue(categoriaNueva.nombre);
                Logger.log('‚úÖ Actualizado: "' + cellValue + '" ‚Üí "' + categoriaNueva.nombre + '"');
                actualizaciones++;
              }
            }
          }
        }
        
        if (actualizaciones > 0) {
          Logger.log('‚úÖ Hoja "' + nombreHoja + '": ' + actualizaciones + ' headers actualizados');
          hojasActualizadas++;
        } else {
          Logger.log('‚ÑπÔ∏è Hoja "' + nombreHoja + '": Sin cambios');
        }
        
      } catch (error) {
        Logger.log('‚ùå Error en hoja "' + nombreHoja + '": ' + error.toString());
        errores.push({ hoja: nombreHoja, error: error.toString() });
      }
    });
    
    Logger.log('üéâ Proceso completado. Hojas actualizadas: ' + hojasActualizadas + '/' + todasLasHojas.length);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      hojasActualizadas: hojasActualizadas,
      totalHojas: todasLasHojas.length,
      errores: errores
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('‚ùå Error al actualizar categor√≠as: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function buscarCategoriaPorNumero(numero, categorias) {
  for (var i = 0; i < categorias.length; i++) {
    if (categorias[i].numero === numero) {
      return categorias[i];
    }
  }
  return null;
}

// ==================== INICIALIZAR SHEET ====================

function getNombreCategoria(numero, categorias) {
  if (!categorias || categorias.length === 0) {
    return 'Categor√≠a ' + numero;
  }
  
  for (var i = 0; i < categorias.length; i++) {
    if (categorias[i].numero === numero) {
      return categorias[i].nombre;
    }
  }
  
  return 'Categor√≠a ' + numero;
}

function inicializarSheetAuto(config) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    let sheet = ss.getSheetByName(config.sheetName);
    if (sheet) {
      Logger.log('‚ö†Ô∏è Sheet ya existe: ' + config.sheetName);
      return { success: true, message: 'Sheet ya exist√≠a' };
    }
    
    sheet = ss.insertSheet(config.sheetName);
    
    const diasEnMes = new Date(config.a√±o, getMesNumero(config.mes), 0).getDate();
    const headers = ['Nombre'];
    for (var i = 1; i <= diasEnMes; i++) headers.push('D√≠a ' + i);
    
    var row = 1;
    
    sheet.getRange(row, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(row, 1, 1, headers.length).setFontWeight('bold');
    sheet.getRange(row, 1, 1, headers.length).setBackground('#1a472a');
    sheet.getRange(row, 1, 1, headers.length).setFontColor('#ffffff');
    sheet.getRange(row, 1, 1, headers.length).setHorizontalAlignment('center');
    row++;
    
    const categorias = config.categorias || [];
    
    const categoriasConJugadores = {};
    config.jugadores.forEach(function(j) {
      if (!categoriasConJugadores[j.categoria]) {
        categoriasConJugadores[j.categoria] = [];
      }
      categoriasConJugadores[j.categoria].push(j);
    });
    
    const todasCategorias = categorias.sort(function(a, b) { return a.numero - b.numero; });
    
    const categoriasAMostrar = todasCategorias.length > 0 
      ? todasCategorias 
      : Object.keys(categoriasConJugadores).map(function(num) { 
          return { numero: parseInt(num), nombre: 'Categor√≠a ' + num }; 
        }).sort(function(a, b) { return a.numero - b.numero; });
    
    Logger.log('üìã Categor√≠as a mostrar: ' + categoriasAMostrar.length);
    
    categoriasAMostrar.forEach(function(categoria) {
      row++;
      
      const nombreCategoria = categoria.nombre || getNombreCategoria(categoria.numero, categorias);
      sheet.getRange(row, 1).setValue(nombreCategoria);
      sheet.getRange(row, 1).setFontWeight('bold');
      sheet.getRange(row, 1).setFontSize(12);
      sheet.getRange(row, 1).setBackground('#f3f3f3');
      row++;
      
      const jugadoresCategoria = config.jugadores.filter(function(j) { 
        return j.categoria === categoria.numero && j.activo !== false;
      });
      
      Logger.log('üìã ' + nombreCategoria + ': ' + jugadoresCategoria.length + ' jugadores');
      
      if (jugadoresCategoria.length === 0) {
        sheet.getRange(row, 1).setValue('(Sin jugadores)');
        sheet.getRange(row, 1).setFontStyle('italic');
        sheet.getRange(row, 1).setFontColor('#999999');
        row++;
      } else {
        jugadoresCategoria.forEach(function(jugador) {
          sheet.getRange(row, 1).setValue(jugador.nombre);
          row++;
        });
      }
    });
    
    sheet.setColumnWidth(1, 200);
    for (var i = 2; i <= diasEnMes + 1; i++) {
      sheet.setColumnWidth(i, 100);
    }
    
    sheet.setFrozenRows(1);
    sheet.setFrozenColumns(1);
    
    Logger.log('‚úÖ Sheet creado: ' + config.sheetName);
    
    return { success: true };
  } catch (error) {
    Logger.log('‚ùå Error al crear sheet: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function inicializarSheet(data) {
  const resultado = inicializarSheetAuto({
    sheetName: data.sheetName,
    mes: data.mes,
    a√±o: data.a√±o,
    jugadores: data.jugadores,
    categorias: data.categorias || []
  });
  
  return ContentService.createTextOutput(JSON.stringify(resultado))
    .setMimeType(ContentService.MimeType.JSON);
}

function getMesNumero(mes) {
  const meses = {
    'Enero': 1, 'Febrero': 2, 'Marzo': 3, 'Abril': 4,
    'Mayo': 5, 'Junio': 6, 'Julio': 7, 'Agosto': 8,
    'Septiembre': 9, 'Octubre': 10, 'Noviembre': 11, 'Diciembre': 12
  };
  return meses[mes] || 1;
}

// ==================== OBTENER ASISTENCIAS ====================

function obtenerAsistencia(data) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(data.sheetName);
    
    if (!sheet) {
      Logger.log('‚ö†Ô∏è Sheet no encontrado: ' + data.sheetName);
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: 'Sheet no encontrado'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const categoria = data.categoria;
    const dia = data.dia;
    
    Logger.log('üì• Obteniendo asistencia: ' + data.sheetName + ', Cat: ' + categoria + ', D√≠a: ' + dia);
    
    const colIndex = dia + 1;
    const allData = sheet.getDataRange().getValues();
    var categoriaStartRow = -1;
    var categoriaEndRow = -1;
    
    for (var i = 0; i < allData.length; i++) {
      const cellValue = allData[i][0];
      if (cellValue && (
        cellValue.toString().toUpperCase().indexOf('CATEGOR√çA ' + categoria) === 0 ||
        cellValue.toString() === 'M-' + categoria ||
        cellValue.toString().indexOf('Cat') === 0
      )) {
        categoriaStartRow = i + 2;
        break;
      }
    }
    
    if (categoriaStartRow === -1) {
      Logger.log('‚ùå No se encontr√≥ la categor√≠a ' + categoria);
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: 'Categor√≠a no encontrada'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    for (var i = categoriaStartRow; i < allData.length; i++) {
      const cellValue = allData[i][0];
      if (cellValue && (
        cellValue.toString().toUpperCase().indexOf('CATEGOR√çA') === 0 ||
        cellValue.toString().indexOf('M-') === 0 ||
        cellValue.toString().indexOf('Cat') === 0
      )) {
        categoriaEndRow = i;
        break;
      }
    }
    
    if (categoriaEndRow === -1) {
      categoriaEndRow = allData.length;
    }
    
    Logger.log('üìç Categor√≠a ' + categoria + ' filas: ' + categoriaStartRow + ' a ' + categoriaEndRow);
    
    const asistencias = [];
    for (var i = categoriaStartRow; i < categoriaEndRow; i++) {
      const fila = i + 1;
      const nombre = sheet.getRange(fila, 1).getValue();
      
      if (!nombre || nombre === '(Sin jugadores)') continue;
      
      const valor = sheet.getRange(fila, colIndex).getValue();
      const asistio = valor && valor !== '' && valor !== 'AUSENTE';
      
      asistencias.push({
        nombre: nombre,
        asistio: asistio,
        valor: valor || ''
      });
    }
    
    Logger.log('‚úÖ Asistencias obtenidas: ' + asistencias.length);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      asistencias: asistencias
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('‚ùå Error al obtener asistencia: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}